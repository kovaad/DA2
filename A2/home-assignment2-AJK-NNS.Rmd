---
title: "DA2 - Hotels Europe Analysis"
author: "Adam Kovacs, Nam Son Nguyen"
date: "12/04/2021"
geometry: margin=1.8cm
fontsize: 9pt
output: 
  pdf_document:
    fig_caption: true
    latex_engine: xelatex
header-includes: |
  \usepackage{titling}
  \setlength{\droptitle}{-5em}
---

## Introduction

In this project, we analyze the [**hotels-europe dataset**](https://osf.io/r6uqb/) to investigate how high rating is related to the other hotel features in the data. We estimate linear probability, logit, and probit models with distance and stars as explanatory variables. 

```{r import, echo=FALSE, message=FALSE}
#clear memory
rm(list=ls())

#import packages
if (!require(pacman)){
  install.packages("pacman")
}

pacman::p_load(tidyverse, modelsummary, kableExtra, fixest, estimatr, mfx)

# import data
hfeatures <- read_csv('https://osf.io/utwjs/download')

#table(hfeatures$city)

```

## Filtering for city

```{r filter, echo=FALSE}

#filter on London and create binary variable highly_rated
london <- hfeatures %>%
          filter(city_actual == "London") %>%
          mutate(highly_rated = ifelse(rating >= 4, 1, 0)) %>%
          dplyr::select(highly_rated, stars, distance, accommodation_type) %>% 
          na.omit()

```

## Descriptive statistics

```{r descriptives, echo=FALSE}

#create 5th and 95th percentiles

P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}

#create descriptive table
datasummary( (`Highly rated` = highly_rated ) + (`Distance from center` = distance ) + 
               (`Stars` = stars ) ~
               Mean + Median + SD + Min + Max + P05 + P95, 
             data = london,
             title = 'Descriptive stats of main variables' ) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

```
Our descriptive table indicates that 43% of the hotels in London are highly rates. Regarding the other two variables, the distribution of distance from center is right-skewed with an average of 2.60 kilometers, while we can infer a roughly normal distribution (mean ~ median) for stars with an average of 3.45.

## Regressions

```{r, echo=FALSE}
#assess accomodation type as other explanatory variable
unique(london$accommodation_type)
#linear probability model
lpm <- feols(highly_rated ~ distance + stars + as.factor(accommodation_type), data=london, vcov = 'hetero')
#logit model
logit <- glm(highly_rated ~ distance + stars + as.factor(accommodation_type), data=london, family = "binomial")
#logit model marginal effects
logitm <- logitmfx(highly_rated ~ distance + stars + as.factor(accommodation_type), data=london, atmean = F, robust = T)
#probit model
probit <- glm(highly_rated ~ distance + stars + as.factor(accommodation_type), data=london, family = binomial(link = "probit"))
#probit model marginal effects
probitm <- probitmfx(highly_rated ~ distance + stars + as.factor(accommodation_type), data=london, atmean = F, robust = T)
#summary of models
msummary(list("LPM" = lpm, "Logit" = logit, "Logit_marginal" = logitm, "Probit" =  probit, "Probit_marginal" = probitm),
         fmt="%.2f",
         gof_omit = 'DF|Deviance|Log.Lik.|F|R2 Adj.|R2 Within|R2 Pseudo|R2',
         stars=c('*' = .05, '**' = .01),
         estimate = "{estimate} ({std.error}){stars}",
         statistic = NULL,
         coef_rename = c("(Intercept)" = "Constant",
                         "distance" = "Distance",
                         "stars" = "Stars",
                         "as.factor(accommodation_type)Apartment" = "High school graduate",
                         "as.factor(accommodation_type)Bed and breakfast" = "College no degree",
                         "as.factor(accommodation_type)Guest House" = "Guest House",
                         "as.factor(accommodation_type)Hostel" = "Hostel",
                         "as.factor(accommodation_type)Hotel" = "Hotel",
                         "as.factor(accommodation_type)Inn" = "Inn"),
         title = "Highly rated") %>% 
        column_spec(1:6, width = "7em") %>%
        kable_classic(full_width = F, position = "center" )

```

## Predict

```{r}

#Append predictions to table
london$pred_lpm <- predict( lpm )
london$pred_logit <- predict( logit, type="response" )
london$pred_probit <- predict( probit, type="response" )

```


## DataViz

```{r, echo=FALSE, fig.align='center'}

#Distribution of predicted values
#Some falls outside the [0,1] interval
ggplot(data=london, aes(x=pred_lpm)) +
  geom_histogram(aes(y=..count../sum(..count..)), binwidth = 0.05, fill = "lightgreen", color = "green") +
  coord_cartesian(xlim = c(-0.4, 1.1)) +
  labs(title = "Distribution of Predicted Probabilities",
       x = "Predicted probability of being highly rated (LPM)",
       y = "Percent") +
  scale_y_continuous(expand = c(0.00,0.0), limits = c(0,0.2), breaks = seq(0, 0.2, 0.05), labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(expand = c(0.001,0.01), limits = c(-0.4,1.1), breaks = seq(-0.4,1.1, 0.2)) +
  theme_bw()

#Prediction evaluation
#Logit, probit estimates higher values for higher lpm, and lower for lower LPM
ggplot(data = london) +
  geom_point(aes(x=pred_lpm, y=pred_probit, color="Probit"), size=0.4,  shape=16) +
  geom_point(aes(x=pred_lpm, y=pred_logit,  color="Logit"), size=0.4,  shape=16) +
  geom_line(aes(x=pred_lpm, y=pred_lpm,    color="45 degree line"), size=0.4) +
  labs(title = "Model Comparison",
       x = "Predicted probability of staying healthy (LPM)",
       y="Predicted probability")+
  scale_y_continuous(expand = c(0.00,0.0), limits = c(0,1), breaks = seq(0,1,0.1)) +
  scale_x_continuous(expand = c(0.00,0.0), limits = c(0,1), breaks = seq(0,1,0.1)) +
  theme(legend.position=c(0.55,0.08),
        legend.direction = "horizontal",
        legend.title = element_blank(),
        legend.text = element_text(size = 4))


```

## Conclusion
